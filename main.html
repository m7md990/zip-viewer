<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ZIP Image Viewer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
body { font-family: sans-serif; direction: rtl; padding: 20px; background:#f5f5f5; color:#111; transition: background 0.3s, color 0.3s; }
body.dark { background:#121212; color:#ddd; }
.folder { cursor: pointer; padding: 12px; border: 1px solid #ccc; border-radius: 10px; background:#f7f7f7; margin:6px 0; transition: background 0.3s, color 0.3s; }
body.dark .folder { background:#1e1e1e; color:#ddd; border-color:#333; }
.grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:15px; margin-top:20px; }
img { width:100%; border-radius:10px; }
button { padding:10px 20px; margin:10px 0; cursor:pointer; border-radius:6px; border:none; background:#4caf50; color:white; font-weight:bold; }
button:hover { background:#45a049; }
.progress-container { margin-top: 20px; width:100%; background:#eee; border-radius:5px; overflow:hidden; }
.progress-bar { width:0%; height:20px; background:#4caf50; border-radius:5px; text-align:center; color:white; line-height:20px; white-space:nowrap; transition: width 0.2s; }
.msg { margin-top:12px; color:#b00; }
pre { background:#f4f4f4; padding:10px; border-radius:6px; overflow:auto; }
body.dark pre { background:#1e1e1e; color:#ddd; }
</style>
</head>
<body>
<h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø·ÙˆØ±</h2>
<div class="progress-container"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="viewer"></div>

<script>
let zipObj;

/* --- IndexedDB --- */
function openDB() {
    return new Promise((resolve,reject)=>{
        const req = indexedDB.open('zipDB',1);
        req.onupgradeneeded = e=>{
            const db = e.target.result;
            if(!db.objectStoreNames.contains('zips')) db.createObjectStore('zips');
        };
        req.onsuccess = e=>resolve(e.target.result);
        req.onerror = e=>reject(e);
    });
}

async function getZip(key){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
        const tx = db.transaction('zips','readonly');
        const store = tx.objectStore('zips');
        const req = store.get(key);
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = e=>reject(e);
    });
}

async function saveZip(key, data){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
        const tx = db.transaction('zips','readwrite');
        const store = tx.objectStore('zips');
        const req = store.put(data,key);
        req.onsuccess = ()=>resolve();
        req.onerror = e=>reject(e);
    });
}

/* --- Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£ --- */
function showError(err){
    const viewer=document.getElementById('viewer');
    viewer.innerHTML=`<p class="msg">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:</p><pre>${err}</pre>`;
    console.error(err);
    const pb=document.getElementById('progressBar');
    if(pb){pb.style.width='0%'; pb.textContent='Ø®Ø·Ø£';}
}

/* --- ØªØ­ÙˆÙŠÙ„ chunks Ø¥Ù„Ù‰ Uint8Array --- */
function concatChunks(chunks,totalLength){
    const result=new Uint8Array(totalLength);
    let offset=0;
    for(const c of chunks){ result.set(c,offset); offset+=c.length; }
    return result;
}

/* --- ØªØ­Ù…ÙŠÙ„ ZIP Ù…Ø¹ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø­Ø¬Ù… --- */
async function loadZip(){
    try{
        const url='https://pub-64ea7c0b4e8d44fb86d9a76223463ea2.r2.dev/p.zip';

        // Ø¬Ù„Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        const headResp = await fetch(url, { method:'HEAD' });
        if(!headResp.ok) throw new Error(`HTTP ${headResp.status} ${headResp.statusText} Ø¹Ù†Ø¯ HEAD`);
        const serverSize = parseInt(headResp.headers.get('Content-Length')||'0',10);

        let stored = await getZip('p.zip');
        if(stored && stored.size === serverSize){
            zipObj = await JSZip.loadAsync(stored.buffer);
            document.getElementById('progressBar').style.display='none';
            renderRoot();
            console.log('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ IndexedDB');
            return;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        const resp = await fetch(url);
        if(!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText} Ø¹Ù†Ø¯ GET`);
        const contentType = resp.headers.get('Content-Type')||'';
        if(contentType.includes('text/html')){
            const text = await resp.text().catch(()=>'(Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰)');
            throw new Error(`Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±Ø³Ù„ Ù„ÙŠØ³ ZIP\n\n${text.slice(0,2000)}`);
        }

        const totalLength = serverSize || null;
        const reader = resp.body.getReader();
        const chunks=[];
        let received=0;
        const pb = document.getElementById('progressBar');

        while(true){
            const {done,value}=await reader.read();
            if(done) break;
            chunks.push(value);
            received+=value.length;
            if(totalLength){
                const percent=Math.round((received/totalLength)*100);
                pb.style.width=percent+'%';
                pb.textContent=percent+'%';
            } else {
                const approx=Math.min(99,Math.round((Math.log(received+1)/Math.log(1024*1024))*10)*10);
                pb.style.width=approx+'%';
                pb.textContent=approx+'%';
            }
        }

        const buffer = concatChunks(chunks,received);
        await saveZip('p.zip',{ buffer, size: serverSize });
        zipObj = await JSZip.loadAsync(buffer);
        pb.style.width='100%';
        pb.textContent='100%';
        setTimeout(()=>pb.style.display='none',500);
        renderRoot();
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† R2 ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ IndexedDB');

    }catch(err){ showError(err); }
}

/* --- Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª --- */
function getTopLevelFolders(){
    const set=new Set();
    zipObj.forEach((path,file)=>{
        const parts=path.split('/').filter(Boolean);
        if(parts.length===0) return;
        if(file.dir) set.add(parts.join('/'));
        else if(parts.length>=2) set.add(parts[0]);
        else if(!file.dir && parts.length===1) set.add('root');
    });
    return Array.from(set);
}

function renderRoot(){
    const viewer=document.getElementById('viewer');
    viewer.innerHTML='';
    const folders=getTopLevelFolders();
    if(folders.length===0){ viewer.innerHTML='<p class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø£Ùˆ Ù…Ø¬Ù„Ø¯Ø§Øª Ø¯Ø§Ø®Ù„ ZIP</p>'; return; }

    folders.forEach(name=>{
        const displayName=name==='root'?'Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ':name;
        const div=document.createElement('div');
        div.className='folder';
        div.textContent='ğŸ“ '+displayName;
        div.onclick=()=>renderFolder(name);
        viewer.appendChild(div);
    });
}

async function renderFolder(folderName){
    const viewer=document.getElementById('viewer');
    viewer.innerHTML='';

    const backTop=document.createElement('button');
    backTop.textContent='Ø±Ø¬ÙˆØ¹';
    backTop.onclick=()=>renderRoot();
    viewer.appendChild(backTop);

    const grid=document.createElement('div');
    grid.className='grid';
    const files=[];
    zipObj.forEach((path,file)=>{
        const p=path.replace(/\/$/,'');
        if(file.dir) return;
        if(folderName==='root'){
            if(!p.includes('/')) files.push(file);
        }else{
            if(p.startsWith(folderName+'/')) files.push(file);
            else if(p.split('/')[0]===folderName && !p.includes('/')) files.push(file);
        }
    });

    if(files.length===0){ viewer.innerHTML+='<p class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯</p>'; return; }

    for(const file of files){
        if(/\.(jpg|jpeg|png|gif|webp)$/i.test(file.name)){
            const blob=await file.async('blob');
            const url=URL.createObjectURL(blob);
            const img=document.createElement('img');
            img.src=url;
            grid.appendChild(img);
        }
    }

    const backBottom=document.createElement('button');
    backBottom.textContent='Ø±Ø¬ÙˆØ¹';
    backBottom.onclick=()=>renderRoot();
    grid.appendChild(backBottom);

    viewer.appendChild(grid);
}

/* --- Dark Mode Toggle --- */
const darkBtn=document.createElement('button');
darkBtn.textContent='ØªÙØ¹ÙŠÙ„ / ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
darkBtn.onclick=()=>document.body.classList.toggle('dark');
document.body.insertBefore(darkBtn,document.getElementById('viewer'));

/* --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ --- */
loadZip();
</script>
</body>
</html>
