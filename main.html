<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ZIP Image Viewer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
 body { font-family: sans-serif; direction: rtl; padding: 20px; }
 .folder { cursor: pointer; padding: 12px; border: 1px solid #ccc; margin: 6px; border-radius: 10px; background:#f7f7f7; }
 .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top:20px; }
 img { width: 100%; border-radius: 10px; }
 button { padding:10px 20px; margin-bottom:20px; }
 .msg { margin-top:12px; color:#b00; }
 .info { margin-top:12px; color:#1a73e8; }
 .progress-container { margin-top: 20px; width: 100%; background-color: #eee; border-radius: 5px; overflow: hidden; }
 .progress-bar { width: 0%; height: 20px; background-color: #4caf50; border-radius: 5px; text-align: center; color: white; line-height: 20px; white-space: nowrap; }
 pre { background:#f4f4f4; padding:10px; border-radius:6px; overflow:auto; }
</style>
</head>
<body>
<h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø·ÙˆØ±</h2>

<div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="viewer"></div>

<script>
let zipObj;

/**
 * ÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
 * @param {string} userMsg - Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ØµÙŠØ±Ø©
 * @param {string} details - ØªÙØ§ØµÙŠÙ„ Ù…ÙØµÙ‘Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
 */
function showError(userMsg, details) {
    const viewer = document.getElementById("viewer");
    viewer.innerHTML = '';
    const p = document.createElement('p');
    p.className = 'msg';
    p.textContent = userMsg;
    viewer.appendChild(p);

    if (details) {
        const pre = document.createElement('pre');
        pre.textContent = details;
        viewer.appendChild(pre);
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠØ¶Ø§Ù‹ ÙÙŠ Ø§Ù„Ù€ console
    console.error(userMsg, details || '');
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
    const pb = document.getElementById('progressBar');
    if (pb) {
        pb.style.width = '0%';
        pb.textContent = 'Ø®Ø·Ø£';
    }
}

/**
 * ÙŠØ­ÙˆÙ„ chunks Ø¥Ù„Ù‰ Uint8Array ÙˆØ§Ø­Ø¯
 * @param {Uint8Array[]} chunks
 * @param {number} totalLength
 */
function concatChunks(chunks, totalLength) {
    const result = new Uint8Array(totalLength);
    let offset = 0;
    for (const c of chunks) {
        result.set(c, offset);
        offset += c.length;
    }
    return result;
}

async function loadZipFromReleasesAsset() {
    const assetApiUrl = "https://api.github.com/repos/m7md990/zip-viewer/releases/assets/324069317";

    try {
        const response = await fetch(assetApiUrl, {
            headers: {
                "Accept": "application/octet-stream"
            }
        });

        // Ù„Ùˆ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ø´ OK Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø© ØªØ´Ù…Ù„ Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„Ø©
        if (!response.ok) {
            const text = await response.text().catch(()=>'');
            const details = `HTTP ${response.status} ${response.statusText}\n\nResponse body (first 1000 chars):\n${text.slice(0,1000)}`;
            showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† GitHub Ù„Ù… ØªÙƒÙ† Ù†Ø§Ø¬Ø­Ø©.', details);
            return;
        }

        // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: Ø¥Ø°Ø§ Ø±Ø¬Ø¹ HTML ØºØ§Ù„Ø¨Ù‹Ø§ ÙÙŠÙ‡ Ø®Ø·Ø£ (Ù…Ø«Ù„Ø§Ù‹ ØµÙØ­Ø© Ø®Ø·Ø£ Ø£Ùˆ login)
        const ct = response.headers.get('Content-Type') || '';
        if (ct.includes('text/html')) {
            const text = await response.text().catch(()=>null);
            const details = `Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±Ø³Ù„ Ù‡Ùˆ HTML ÙˆÙ„ÙŠØ³ Ù…Ù„Ù ZIP.\nContent-Type: ${ct}\n\nØªØ¬Ø±ÙŠØ¨ Ø£ÙˆÙ„ 2000 Ø­Ø±Ù Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰:\n${text ? text.slice(0,2000) : '(Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ)'}`;
            showError('Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù„ÙŠØ³ Ù…Ù„Ù ZIP. Ø±Ø¨Ù…Ø§ GitHub Ø£Ø¹Ø§Ø¯ ØµÙØ­Ø© Ø®Ø·Ø£ Ø£Ùˆ Ø·Ù„Ø¨ Ù…ØµØ§Ø¯Ù‚Ø©.', details);
            return;
        }

        // Ù†Ø­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„ÙƒÙ„ÙŠ Ø¥Ù† ØªÙˆÙØ±
        const contentLengthHeader = response.headers.get('Content-Length');
        const totalLength = contentLengthHeader ? parseInt(contentLengthHeader, 10) : null;

        // Ø¥Ø°Ø§ body ØºÙŠØ± Ù…ØªÙˆÙØ± (Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª) Ù†Ø³ØªØ®Ø¯Ù… arrayBuffer Ù…Ø¨Ø§Ø´Ø±Ø© ÙƒØ¨Ø¯ÙŠÙ„
        if (!response.body || !response.body.getReader) {
            // fallback Ø¨Ø³ÙŠØ·
            const buffer = await response.arrayBuffer();
            try {
                zipObj = await JSZip.loadAsync(buffer);
                document.getElementById('progressBar').style.display = 'none';
                renderRoot();
                return;
            } catch (err) {
                showError('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù ZIP (fallback arrayBuffer).', String(err));
                return;
            }
        }

        // Ù‚Ø±Ø§Ø¡Ø© stream ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…
        const reader = response.body.getReader();
        const chunks = [];
        let received = 0;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            if (value) {
                chunks.push(value);
                received += value.length;
                // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø·ÙˆÙ„ Ù…Ø¹Ø±ÙˆÙ
                if (totalLength) {
                    const percent = Math.min(100, Math.round((received / totalLength) * 100));
                    const pb = document.getElementById('progressBar');
                    pb.style.width = percent + '%';
                    pb.textContent = percent + '%';
                } else {
                    // Ø¹Ø±Ø¶ ØªÙ‚Ø¯Ù… ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ØªÙˆÙØ± Ø·ÙˆÙ„
                    const pb = document.getElementById('progressBar');
                    // Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ø´Ø± Ø¨Ø³ÙŠØ· Ù…ØªØ¯Ø±Ø¬
                    const approx = Math.min(99, Math.round((Math.log(received+1) / Math.log(1024*1024)) * 10) * 10);
                    pb.style.width = approx + '%';
                    pb.textContent = approx + '%';
                }
            }
        }

        // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø¨Ø§ÙŠØªØ³
        const all = concatChunks(chunks, received);

        // Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ zip
        try {
            zipObj = await JSZip.loadAsync(all);
        } catch (err) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ JSZipØŒ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…ÙØµÙ‘Ù„Ø© ÙˆÙ†Ø­Ø§ÙˆÙ„ Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ù…Ø­ØªÙˆÙŠØ§Øª Ø®Ø§Ø·Ø¦Ø©
            // Ù†Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ø¨Ø¶Ø¹Ø© Ø¨Ø§ÙŠØªØ³ ÙƒÙ€ hex Ù„Ù„ØªØªØ¨Ù‘Ø¹
            const head = all.slice(0, 64);
            const hex = Array.from(head).map(b => b.toString(16).padStart(2, '0')).join(' ');
            showError('JSZip ÙØ´Ù„ ÙÙŠ ÙØªØ­ Ø§Ù„Ù…Ù„Ù â€” Ø±Ø¨Ù…Ø§ Ø§Ù„Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ Ù„ÙŠØ³ ZIP.', `Ø®Ø·Ø£ JSZip: ${err}\n\nØ£ÙˆÙ„ 64 Ø¨Ø§ÙŠØª (hex):\n${hex}`);
            return;
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        document.getElementById('progressBar').style.display = 'none';
        renderRoot();

    } catch (e) {
        // Ø®Ø·Ø£ Ø¹Ø§Ù… Ù…Ø«Ù„ network failure Ø£Ùˆ CORS
        let details = String(e);
        // Ù„Ùˆ Ø§Ù„Ø®Ø·Ø£ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù€ CORS ØºØ§Ù„Ø¨Ù‹Ø§ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡ÙŠ TypeError: Failed to fetch Ø£Ùˆ Ù…Ø´Ø§Ø¨Ù‡
        if (details.includes('Failed to fetch') || details.includes('NetworkError')) {
            details += '\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¨Ø¨ Ø³ÙŠØ§Ø³Ø§Øª CORS Ø£Ùˆ Ø±ÙØ¶ ÙˆØµÙˆÙ„ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ (GitHub API ÙŠØ­ØªØ§Ø¬ Accept header ÙƒÙ…Ø§ ÙØ¹Ù„Ù†Ø§).';
        }
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.', details);
    }
}

/* --- Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ù† ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ) --- */

function getTopLevelFolders() {
    const set = new Set();
    zipObj.forEach((relativePath, file) => {
        const parts = relativePath.split('/').filter(Boolean);
        if (parts.length === 0) return;
        if (file.dir) {
            set.add(parts.join('/'));
        } else if (parts.length >= 2) {
            set.add(parts[0]);
        } else if (!file.dir && parts.length === 1) {
            set.add('root');
        }
    });
    return Array.from(set);
}

function renderRoot() {
    const viewer = document.getElementById("viewer");
    viewer.innerHTML = "";

    const folders = getTopLevelFolders();
    if (folders.length === 0) {
        viewer.innerHTML = '<p class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø£Ùˆ Ù…Ø¬Ù„Ø¯Ø§Øª Ø¯Ø§Ø®Ù„ ZIP</p>';
        return;
    }

    folders.forEach(folderName => {
        const name = folderName === 'root' ? 'Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ' : folderName;
        const div = document.createElement("div");
        div.className = "folder";
        div.textContent = "ğŸ“ " + name;
        div.onclick = () => renderFolder(folderName);
        viewer.appendChild(div);
    });
}

async function renderFolder(folderName) {
    const viewer = document.getElementById("viewer");
    viewer.innerHTML = "";

    const back = document.createElement("button");
    back.textContent = "Ø±Ø¬ÙˆØ¹";
    back.onclick = () => renderRoot();
    viewer.appendChild(back);

    const grid = document.createElement("div");
    grid.className = "grid";

    const files = [];
    zipObj.forEach((relativePath, file) => {
        const path = relativePath.replace(/\/$/, '');
        if (file.dir) return;
        if (folderName === 'root') {
            if (!path.includes('/')) files.push(file);
        } else {
            if (path.startsWith(folderName + '/')) files.push(file);
            else if (path.split('/')[0] === folderName && !path.includes('/')) files.push(file);
        }
    });

    if (files.length === 0) {
        viewer.innerHTML += '<p class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯</p>';
        return;
    }

    for (const file of files) {
        if (/\.(jpg|jpeg|png|gif|webp)$/i.test(file.name)) {
            const blob = await file.async("blob");
            const url = URL.createObjectURL(blob);
            const img = document.createElement("img");
            img.src = url;
            grid.appendChild(img);
        }
    }

    viewer.appendChild(grid);
}

/* --- Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„ --- */
loadZipFromReleasesAsset();
</script>
</body>
</html>
