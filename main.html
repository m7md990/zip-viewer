<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ZIP Image Viewer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
 body { font-family: sans-serif; direction: rtl; padding: 20px; }
 .folder { cursor: pointer; padding: 12px; border: 1px solid #ccc; margin: 6px; border-radius: 10px; background:#f7f7f7; }
 .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top:20px; }
 img { width: 100%; border-radius: 10px; }
 button { padding:10px 20px; margin-bottom:20px; }
 .msg { margin-top:12px; color:#b00; }
 .info { margin-top:12px; color:#1a73e8; }
 .progress-container { margin-top: 20px; width: 100%; background-color: #eee; border-radius: 5px; overflow: hidden; }
 .progress-bar { width: 0%; height: 20px; background-color: #4caf50; border-radius: 5px; text-align: center; color: white; line-height: 20px; white-space: nowrap; }
 pre { background:#f4f4f4; padding:10px; border-radius:6px; overflow:auto; }
</style>
</head>
<body>
<h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø·ÙˆØ±</h2>

<div class="progress-container"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="viewer"></div>

<script>
let zipObj;

/* --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ --- */
function showError(err) {
    const viewer = document.getElementById('viewer');
    viewer.innerHTML = `<p class="msg">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:</p><pre>${err}</pre>`;
    console.error(err);
    const pb = document.getElementById('progressBar');
    if(pb) { pb.style.width='0%'; pb.textContent='Ø®Ø·Ø£'; }
}

/* --- Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ chunks Ø¥Ù„Ù‰ Uint8Array --- */
function concatChunks(chunks, totalLength) {
    const result = new Uint8Array(totalLength);
    let offset = 0;
    for (const c of chunks) {
        result.set(c, offset);
        offset += c.length;
    }
    return result;
}

/* --- Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ZIP Ù…Ù† Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ --- */
async function loadZip() {
    const url = "https://pub-64ea7c0b4e8d44fb86d9a76223463ea2.r2.dev/p.zip";

    try {
        const response = await fetch(url);
        if (!response.ok) {
            const text = await response.text().catch(()=>'');
            throw new Error(`HTTP ${response.status} ${response.statusText}\n\nResponse body:\n${text.slice(0,1000)}`);
        }

        const contentType = response.headers.get('Content-Type') || '';
        if (contentType.includes('text/html')) {
            const text = await response.text().catch(()=>'(Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰)');
            throw new Error(`Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±Ø³Ù„ Ù„ÙŠØ³ ZIP (Content-Type: ${contentType})\n\nØ£ÙˆÙ„ 2000 Ø­Ø±Ù:\n${text.slice(0,2000)}`);
        }

        const arrayBuffer = await response.arrayBuffer();

        try {
            zipObj = await JSZip.loadAsync(arrayBuffer);
        } catch (err) {
            const head = new Uint8Array(arrayBuffer.slice(0,64));
            const hex = Array.from(head).map(b=>b.toString(16).padStart(2,'0')).join(' ');
            throw new Error(`ÙØ´Ù„ JSZip ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ${err}\n\nØ£ÙˆÙ„ 64 Ø¨Ø§ÙŠØª (hex):\n${hex}`);
        }

        document.getElementById('progressBar').style.display='none';
        renderRoot();

    } catch (err) {
        showError(err);
    }
}

/* --- Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª --- */
function getTopLevelFolders() {
    const set = new Set();
    zipObj.forEach((relativePath, file) => {
        const parts = relativePath.split('/').filter(Boolean);
        if (parts.length === 0) return;
        if (file.dir) set.add(parts.join('/'));
        else if (parts.length >= 2) set.add(parts[0]);
        else if (!file.dir && parts.length === 1) set.add('root');
    });
    return Array.from(set);
}

function renderRoot() {
    const viewer = document.getElementById("viewer");
    viewer.innerHTML = "";

    const folders = getTopLevelFolders();
    if (folders.length === 0) {
        viewer.innerHTML = '<p class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø£Ùˆ Ù…Ø¬Ù„Ø¯Ø§Øª Ø¯Ø§Ø®Ù„ ZIP</p>';
        return;
    }

    folders.forEach(folderName => {
        const name = folderName === 'root' ? 'Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ' : folderName;
        const div = document.createElement("div");
        div.className = "folder";
        div.textContent = "ğŸ“ " + name;
        div.onclick = () => renderFolder(folderName);
        viewer.appendChild(div);
    });
}

async function renderFolder(folderName) {
    const viewer = document.getElementById("viewer");
    viewer.innerHTML = "";

    const back = document.createElement("button");
    back.textContent = "Ø±Ø¬ÙˆØ¹";
    back.onclick = () => renderRoot();
    viewer.appendChild(back);

    const grid = document.createElement("div");
    grid.className = "grid";

    const files = [];
    zipObj.forEach((relativePath, file) => {
        const path = relativePath.replace(/\/$/, '');
        if (file.dir) return;
        if (folderName === 'root') {
            if (!path.includes('/')) files.push(file);
        } else {
            if (path.startsWith(folderName + '/')) files.push(file);
            else if (path.split('/')[0] === folderName && !path.includes('/')) files.push(file);
        }
    });

    if (files.length === 0) {
        viewer.innerHTML += '<p class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯</p>';
        return;
    }

    for (const file of files) {
        if (/\.(jpg|jpeg|png|gif|webp)$/i.test(file.name)) {
            const blob = await file.async("blob");
            const url = URL.createObjectURL(blob);
            const img = document.createElement("img");
            img.src = url;
            grid.appendChild(img);
        }
    }

    viewer.appendChild(grid);
}

/* --- Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ ZIP --- */
loadZip();
</script>
</body>
</html>
